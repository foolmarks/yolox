# start the docker container
./start.py


# navigate to workspace
cd docker/sima-cli


# run graph surgery
python yolox_surgery_no_reshape.py --size s

# unzip images
unzip calib_images.zip
unzip test_images.zip


# run FP32 ONNX model
python run_onnx.py


# quantize, compile, evaluate
python run_modelsdk.py -e 

# test model in HW
python run_accelmode.py


#  benchmark
python ./get_fps/network_eval/network_eval.py \
    --model_file_path   ./build/yolox_s_opt_no_reshapes/benchmark/yolox_s_opt_no_reshapes_stage1_mla.elf \
    --mpk_json_path     ./build/yolox_s_opt_no_reshapes/benchmark/yolox_s_opt_no_reshapes_mpk.json \
    --dv_host           192.168.1.29 \
    --image_size        640 640 3 \
    --verbose \
    --bypass_tunnel \
    --max_frames        100 \
    --batch_size        1




# make baseline GStreamer application
mpk project create --model-path ./build/yolox_s_opt_no_reshapes/yolox_s_opt_no_reshapes_mpk.tar.gz --src-plugin rtspsrc --input-width 1280 --input-height 720

# modifications

.project/pluginsInfo.json. Add:

        {
            "gid" : "yolox_postproc_overlay",
            "path" : "plugins/yolox_postproc_overlay"
        }


modify CVU configuration 0_preproc.json:

  - change normalize to false: "normalize": false,
  - change input image type to NV12: "input_img_type": "NV12",




create 'yolovx_postproc_overlay' plugin:

mkdir -p ./yolox_s_opt_no_reshapes_mpk_rtspsrc/plugins/yolovx_postproc_overlay
cp /usr/local/simaai/plugin_zoo/gst-simaai-plugins-base/gst/templates/aggregator_python/python/*.py ./yolox_s_opt_no_reshapes_mpk_rtspsrc/plugins/yolovx_postproc_overlay/.

copy contents of <...> into ./yolox_s_opt_no_reshapes_mpk_rtspsrc/plugins/yolovx_postproc_overlay/payload.py


application.json

  - add 'yolovx_postproc_overlay' plugin
   
    {
      "name": "simaai_yolovx_postproc_overlay",
      "pluginGid": "yolovx_postproc_overlay",
      "sequence" : 4
    }
 
 new gst string:

    "gst": "rtspsrc location=rtsp://192.168.1.17:8080/h264_ulaw.sdp ! rtph264depay wait-for-keyframe=true ! h264parse ! 'video/x-h264, parsed=true, stream-format=(string)byte-stream, alignment=(string)au, width=(int)[1,4096], height=(int)[1,4096]' ! simaaidecoder name=decoder sima-allocator-type=2 ! tee name=source ! queue2 ! simaaiprocesscvu  name=simaaiprocesspreproc_1 ! simaaiprocessmla  name=simaaiprocessmla_1 ! simaaiprocesscvu  name=simaaiprocessdetess_dequant_1 ! yolox_postproc_overlay  name='simaai_yolox_postproc_overlay' ! queue2 ! 'video/x-raw,format=NV12,width=1280,height=720,framerate=30/1' ! simaaiencoder enc-bitrate=4000 name=encoder1 ! h264parse ! rtph264pay ! udpsink host=192.168.1.59 port=7000 source. ! queue2 ! simaai_yolox_postproc_overlay. "




# compile pipeline
cd yolox_s_opt_no_reshapes_mpk_rtspsrc
mpk create --board-type modalix --clean -s . -d .

mpk device connect -d devkit -u sima -p edgeai -t 192.168.1.29
mpk deploy -f ./project.mpk -d devkit -t 192.168.1.29


